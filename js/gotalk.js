!function(e){"use strict";var t,r={},n={},o=0,a=function(e){var t,a=e.replace(/^.\//,"");if(!(t=n[a])){for(var s=0;s<o;s++)". ";var i=r[a];i&&o<100&&(r[a]=null,n[a]={exports:{}},++o,i(n[a]),--o,n[a]=n[a].exports),t=n[a]}return t};r.EventEmitter=function(e){e.exports;function t(){}e.exports=t,t.prototype.addListener=function(e,t){if("function"!=typeof t)throw TypeError("listener must be a function");if(!this.__events)return Object.defineProperty(this,"__events",{value:{},enumerable:!1,writable:!0}),this.__events[e]=[t],this;var r=this.__events[e];return void 0===r?(this.__events[e]=[t],this):(r.push(t),this)},t.prototype.on=t.prototype.addListener,t.prototype.once=function(e,t){var r=!1,n=function(){this.removeListener(e,n),r||(r=!0,t.apply(this,arguments))};return this.on(e,n)},t.prototype.removeListener=function(e,t){var r,n=this.__events?this.__events[e]:void 0;if(void 0!==n){for(;-1!==(r=n.indexOf(t));)n.splice(r,1);return 0===n.length&&delete this.__events[e],n.length}return this},t.prototype.removeAllListeners=function(e){this.__events&&(e?delete this.__events[e]:delete this.__events)},t.prototype.listeners=function(e){return e?this.__events?this.__events[e]:void 0:this.__events},t.prototype.emit=function(e){var t=this.__events?this.__events[e]:void 0;if(void 0===t)return!1;for(var r=0,n=t.length,o=Array.prototype.slice.call(arguments,1);r!==n;++r)t[r]||console.log("e",e,r,o),t[r].apply(this,o);return!0},t.mixin=function(e){for(var r=e;r;){if(r.__proto__===Object.prototype)return r.__proto__=t.prototype,e;r=r.__proto__}return e}},r.buf=function(e){var t;e.exports;if("undefined"!=typeof Uint8Array){var r=a("./utf8");(t=function(e){return e instanceof Uint8Array?e:new Uint8Array(e instanceof ArrayBuffer?e:new ArrayBuffer(e))}).isBuf=function(e){return e instanceof Uint8Array},t.fromString=function(e,n){return r.encode(e,t)}}e.exports=t},r.keepalive=function(e){e.exports;var t=a("./netaccess"),r=a("./protocol");e.exports=function(e,n,o,a){o?o<100&&(o=100):o=500,(!a||a<o)&&(a=5e3);var s,i,l,u,d,c=0;return s={isEnabled:!1,isConnected:!1,enable:function(){s.enabled||(s.enabled=!0,c=0,s.isConnected||i())},disable:function(){s.enabled&&(clearTimeout(u),s.enabled=!1,c=0)}},i=function(){clearTimeout(u),e.open(n,(function(t){d=new Date,t?l(t):(c=0,s.isConnected=!0,e.once("close",l))}))},l=function(e){if(clearTimeout(u),s.isConnected=!1,s.enabled){if(t.available&&!t.onLine&&("undefined"==typeof document||!document.location||"localhost"===document.location.hostname||"127.0.0.1"===document.location.hostname||"[::1]"===document.location.hostname))return t.once("online",l),void(c=0);c=e?e.isGotalkProtocolError?e.code===r.ErrorTimeout?0:a:c?Math.min(a,2*c):o:Math.max(0,o-(new Date-d)),u=setTimeout(i,c)}},s}},r.netaccess=function(t){t.exports;var r,n=a("./EventEmitter");void 0!==e&&e.addEventListener?(r=Object.create(n.prototype,{available:{value:!0,enumerable:!0},onLine:{value:!0,enumerable:!0,writable:!0}}),"undefined"!=typeof navigator&&(r.onLine=navigator.onLine),e.addEventListener("offline",(function(e){r.onLine=!1,r.emit("offline")})),e.addEventListener("online",(function(e){r.onLine=!0,r.emit("online")}))):r={available:!1,onLine:!0},t.exports=r},r.protocol=function(e){var t=e.exports,r=a("./buf"),n=a("./utf8");t.Version=1;var o=t.MsgTypeSingleReq=114,s=t.MsgTypeStreamReq=115,i=(t.MsgTypeStreamReqPart=112,t.MsgTypeSingleRes=82,t.MsgTypeStreamRes=83,t.MsgTypeErrorRes=69,t.MsgTypeRetryRes=101),l=t.MsgTypeNotification=110,u=t.MsgTypeHeartbeat=104,d=t.MsgTypeProtocolError=102;function c(e,t,r,n){for(var o,a=t||0,s=0,i=r.toString(16),l=n-i.length;l--;)e[a++]=48;for(;!isNaN(o=i.charCodeAt(s++));)e[a++]=o}function f(e,t){var n=r(t);return c(n,0,e,t),n}t.ErrorAbnormal=0,t.ErrorUnsupported=1,t.ErrorInvalidMsg=2,t.ErrorTimeout=3,t.HeartbeatMsgMaxLoad=65535,t.binary={makeFixnum:f,versionBuf:f(t.Version,2),parseVersion:function(e){return parseInt(e,16)},parseMsg:function(e){var t,r,a,c,f,p=0;return f=1,(t=e[0])===u?(p=parseInt(e.subarray(f,f+4),16),f+=4):t!==l&&t!==d&&(r=e.subarray(f,f+4),f+=4),t==o||t==s||t==l?(c=parseInt(e.subarray(f,f+3),16),f+=3,a=n.decode(e,f,f+c),f+=c):t===i&&(p=parseInt(e.subarray(f,f+8),16),f+=8),{t,id:r,name:a,wait:p,size:parseInt(e.subarray(f,f+8),16)}},makeMsg:function(e,t,n,o,a){var s,l,u=t?13:9;return n&&0!==n.length&&(u+=3+(l=r.fromString(n)).length),(s=r(u))[0]=e,u=1,t&&4===t.length&&("string"==typeof t?(s[1]=t.charCodeAt(0),s[2]=t.charCodeAt(1),s[3]=t.charCodeAt(2),s[4]=t.charCodeAt(3)):(s[1]=t[0],s[2]=t[1],s[3]=t[2],s[4]=t[3]),u+=4),n&&0!==n.length&&(c(s,u,(l=r.fromString(n)).length,3),u+=3,l.copy(s,u),u+=l.length),e===i&&(c(s,u,o,8),u+=8),c(s,u,a,8),s},makeHeartbeatMsg:function(e){var t=r(13),n=1;return t[0]=u,c(t,n,e,4),c(t,n+=4,Math.round((new Date).getTime()/1e3),8),n+=8,t}};function p(e,t){var r=e.toString(16);return"00000000".substr(0,t-r.length)+r}t.text={makeFixnum:p,versionBuf:p(t.Version,2),parseVersion:function(e){return parseInt(e.substr(0,2),16)},parseMsg:function(e){var t,r,n,a,c=0;return a=1,(t=e.charCodeAt(0))===u?(c=parseInt(e.substr(a,4),16),a+=4):t!==l&&t!==d&&(r=e.substr(a,4),a+=4),t==o||t==s||t==l?n=e.substring(a+3,e.length-8):t==i&&(c=parseInt(e.substr(a,8),16),a+=8),{t,id:r,name:n,wait:c,size:parseInt(e.substr(e.length-8),16)}},makeMsg:function(e,t,r,o,a){var s=String.fromCharCode(e);return t&&4===t.length&&(s+=t),r&&0!==r.length&&(s+=p(n.sizeOf(r),3),s+=r),e===i&&(s+=p(o,8)),s+=p(a,8)},makeHeartbeatMsg:function(e){var t=String.fromCharCode(u);return t+=p(e,4),t+=p(Math.round((new Date).getTime()/1e3),8)}}},r.utf8=function(e){var t=e.exports;function r(e){for(var t,r=0,n=0;t=e.charCodeAt(n++);r+=t>>11?3:t>>7?2:1);return r}function n(e){return 255&e}if(t.sizeOf=r,"undefined"!=typeof TextDecoder){var o=new TextDecoder("utf8"),a=new TextEncoder("utf8");t.decode=function(e,t,r){return(t||r)&&(t||(t=0),e=e.subarray(t,r||e.length-t)),o.decode(e)},t.encode=function(e,t){return t(a.encode(e))}}else t.decode=function(e,t,r){var o,a,s=t||0,i=r||e.length-s,l="";for(s=0;s<i;)(a=n(o=e[s++]))<128||(a>>5==6?o=(o<<6&2047)+(63&e[s++]):a>>4==14?(o=(o<<12&65535)+(n(e[s++])<<6&4095),o+=63&e[s++]):a>>3==30&&(o=(o<<18&2097151)+(n(e[s++])<<12&262143),o+=n(e[s++])<<6&4095,o+=63&e[s++])),l+=String.fromCharCode(o);return l},t.encode=function(e,t){for(var n,o=0,a=e.length,s=0,i=t(r(e));o!==a;)(n=e.charCodeAt(o++))<128?i[s++]=n:n<2048?(i[s++]=n>>6|192,i[s++]=63&n|128):n<65536?(i[s++]=n>>12|224,i[s++]=n>>6&63|128,i[s++]=63&n|128):(i[s++]=n>>18|240,i[s++]=n>>12&63|128,i[s++]=n>>6&63|128,i[s++]=63&n|128);return i}},function(t){var r=t.exports,n=a("./protocol"),o=n.text,s=n.binary,i=a("./buf"),l=a("./utf8"),u=a("./EventEmitter"),d=a("./keepalive"),c=r;function f(e){try{return JSON.parse(e)}catch(e){}}function p(e){return Object.create(p.prototype,{handlers:{value:e,enumerable:!0},protocol:{value:i?n.binary:n.text,enumerable:!0,writable:!0},heartbeatInterval:{value:2e4,enumerable:!0,writable:!0},ws:{value:null,writable:!0},keepalive:{value:null,writable:!0},nextOpID:{value:0,writable:!0},nextStreamID:{value:0,writable:!0},pendingRes:{value:{},writable:!0},hasPendingRes:{get:function(){for(var e in this.pendingRes)return!0}},pendingClose:{value:!1,writable:!0}})}c.protocol=n,c.Buf=i,p.prototype=u.mixin(p.prototype),r.Sock=p;var h={1e3:"normal",1001:"going away",1002:"protocol error",1003:"unsupported",1005:"no status",1006:"abnormal",1007:"inconsistent",1008:"invalid message",1009:"too large"};p.prototype.adoptWebSocket=function(e){var t=this;if(e.readyState!==WebSocket.OPEN)throw new Error("web socket readyState != OPEN");e.binaryType="arraybuffer",t.ws=e,e.onclose=function(r){var n=e._gotalkCloseError;n||1e3===r.code||(n=new Error("websocket closed: "+(h[r.code]||"#"+r.code))),function(e,t){if(e.pendingClose=!1,e.stopSendingHeartbeats(),e.ws&&(e.ws.onmessage=null,e.ws.onerror=null,e.ws.onclose=null,e.ws=null),e.nextOpID=0,e.hasPendingRes){var r=t||new Error("connection closed");for(var n in e.pendingRes)e.pendingRes[n](r);e.pendingRes={}}}(t,n),t.emit("close",n)},e.onmessage=function(t){e._bufferedMessages||(e._bufferedMessages=[]),e._bufferedMessages.push(t.data)}},p.prototype.adopt=function(e){if(adopt instanceof WebSocket)return this.adoptWebSocket(e);throw new Error("unsupported transport")},p.prototype.handshake=function(){this.ws.send(this.protocol.versionBuf)},p.prototype.end=function(){var e=this;e.keepalive&&(e.keepalive.disable(),e.keepalive=null),!e.pendingClose&&e.hasPendingRes?e.pendingClose=!0:e.ws&&e.ws.close(1e3)},p.prototype.address=function(){return this.ws?this.ws.url:null};var g=r.ErrAbnormal=Error("unsupported protocol");g.isGotalkProtocolError=!0,g.code=n.ErrorAbnormal;var v=r.ErrUnsupported=Error("unsupported protocol");v.isGotalkProtocolError=!0,v.code=n.ErrorUnsupported;var y=r.ErrInvalidMsg=Error("invalid protocol message");y.isGotalkProtocolError=!0,y.code=n.ErrorInvalidMsg;var b=r.ErrTimeout=Error("timeout");b.isGotalkProtocolError=!0,b.code=n.ErrorTimeout,p.prototype.sendHeartbeat=function(e){var t=this.protocol.makeHeartbeatMsg(Math.round(e*n.HeartbeatMsgMaxLoad));try{this.ws.send(t)}catch(e){throw(!this.ws||this.ws.readyState>WebSocket.OPEN)&&(e=new Error("socket is closed")),e}},p.prototype.startSendingHeartbeats=function(){var e=this;if(e.heartbeatInterval<10)throw new Error("Sock.heartbeatInterval is too low");clearTimeout(e._sendHeartbeatsTimer);var t=function(){clearTimeout(e._sendHeartbeatsTimer),e.sendHeartbeat(0),e._sendHeartbeatsTimer=setTimeout(t,e.heartbeatInterval)};e._sendHeartbeatsTimer=setTimeout(t,1)},p.prototype.stopSendingHeartbeats=function(){clearTimeout(this._sendHeartbeatsTimer)},p.prototype.startReading=function(){var e,t=this,r=t.ws;function a(a){if((e="string"==typeof a.data?o.parseMsg(a.data):s.parseMsg(i(a.data))).t===n.MsgTypeProtocolError){var u=e.size;u===n.ErrorAbnormal?r._gotalkCloseError=g:u===n.ErrorUnsupported?r._gotalkCloseError=v:u===n.ErrorTimeout?r._gotalkCloseError=b:r._gotalkCloseError=y,r.close(4e3+u)}else 0!==e.size&&e.t!==n.MsgTypeHeartbeat?r.onmessage=l:(t.handleMsg(e),e=null)}function l(n){var o=n.data;r.onmessage=a,t.handleMsg(e,"string"==typeof o?o:i(o)),e=null}r.onmessage=function(e){("string"==typeof e.data?o.parseVersion(e.data):s.parseVersion(i(e.data)))!==n.Version?(r._gotalkCloseError=v,t.closeError(n.ErrorUnsupported)):(r.onmessage=a,t.heartbeatInterval>0&&t.startSendingHeartbeats())},r._bufferedMessages&&(r._bufferedMessages.forEach((function(e){r.onmessage({data:e})})),r._bufferedMessages=null)};var m={};function w(e,t){var r=e.id,o=this,a=o.pendingRes[r];e.t===n.MsgTypeStreamRes&&t&&0!==(t.length||t.size)||(delete o.pendingRes[r],o.pendingClose&&!o.hasPendingRes&&o.end()),"function"==typeof a&&(e.t===n.MsgTypeErrorRes?a(new Error(String(t)),null):a(null,t))}p.prototype.handleMsg=function(e,t){var r=this,o=m[e.t];o?o.call(r,e,t):(r.ws&&(r.ws._gotalkCloseError=y),r.closeError(n.ErrorInvalidMsg))},m[n.MsgTypeSingleReq]=function(e,t){var r,o,a=this;if(r=a.handlers.findRequestHandler(e.name),(o=function(t){a.sendMsg(n.MsgTypeSingleRes,e.id,null,0,t)}).error=function(t){var r=t.message||String(t);a.sendMsg(n.MsgTypeErrorRes,e.id,null,0,r)},"function"!=typeof r)o.error('no such operation "'+e.name+'"');else try{r(t,o,e.name)}catch(e){"undefined"!=typeof console&&console.error(e.stack||e),o.error("internal error")}},m[n.MsgTypeSingleRes]=w,m[n.MsgTypeStreamRes]=w,m[n.MsgTypeErrorRes]=w,m[n.MsgTypeNotification]=function(e,t){var r=this.handlers.findNotificationHandler(e.name);r&&r(t,e.name)},m[n.MsgTypeHeartbeat]=function(e){this.emit("heartbeat",{time:new Date(1e3*e.size),load:e.wait})},p.prototype.sendMsg=function(e,t,r,o,a){var s=a&&"string"==typeof a&&this.protocol===n.binary?l.sizeOf(a):a?a.length||a.size:0,i=this,u=i.protocol.makeMsg(e,t,r,o,s);try{i.ws.send(u),0!==s&&i.ws.send(a)}catch(e){throw(!this.ws||this.ws.readyState>WebSocket.OPEN)&&(e=new Error("socket is closed")),e}},p.prototype.closeError=function(e){var t=this;if(t.ws){try{t.ws.send(t.protocol.makeMsg(n.MsgTypeProtocolError,null,null,0,e))}catch(e){}t.ws.close(4e3+e)}};p.prototype.bufferRequest=function(e,t,r){var o=this,a=o.nextOpID++;1679616===o.nextOpID&&(o.nextOpID=0),a=a.toString(36),a="0000".substr(0,4-a.length)+a,o.pendingRes[a]=r;try{o.sendMsg(n.MsgTypeSingleReq,a,e,0,t)}catch(e){delete o.pendingRes[a],r(e)}},p.prototype.bufferNotify=function(e,t){this.sendMsg(n.MsgTypeNotification,null,e,0,t)},p.prototype.request=function(e,t,r){var n;return r?n=JSON.stringify(t):r=t,this.bufferRequest(e,n,(function(e,t){var n=f(t);return r(e,n)}))},p.prototype.notify=function(e,t){var r=JSON.stringify(t);return this.bufferNotify(e,r)};var E=function(e,t,r){return Object.create(E.prototype,{s:{value:e},op:{value:t,enumerable:!0},id:{value:r,enumerable:!0}})};function M(){return Object.create(M.prototype,{reqHandlers:{value:{}},reqFallbackHandler:{value:null,writable:!0},noteHandlers:{value:{}},noteFallbackHandler:{value:null,writable:!0}})}if(u.mixin(E.prototype),E.prototype.write=function(e){this.ended||(this.started?this.s.sendMsg(n.MsgTypeStreamReqPart,this.id,null,0,e):(this.started=!0,this.s.sendMsg(n.MsgTypeStreamReq,this.id,this.op,0,e)),e&&0!==e.length&&0!==e.size||(this.ended=!0))},E.prototype.end=function(){this.write(null)},p.prototype.streamRequest=function(e){var t=this,r=t.nextStreamID++;46656===t.nextStreamID&&(t.nextStreamID=0),r=r.toString(36),r="!"+"0000".substr(0,3-r.length)+r;var n=E(t,e,r);return t.pendingRes[r]=function(e,t){e?n.emit("end",e):t&&0!==t.length?n.emit("data",t):n.emit("end",null)},n},r.Handlers=M,M.prototype.handleBufferRequest=function(e,t){e?this.reqHandlers[e]=t:this.reqFallbackHandler=t},M.prototype.handleRequest=function(e,t){return this.handleBufferRequest(e,(function(e,r,n){var o=function(e){return r(JSON.stringify(e))};o.error=r.error;var a=f(e);t(a,o,n)}))},M.prototype.handleBufferNotification=function(e,t){e?this.noteHandlers[e]=t:this.noteFallbackHandler=t},M.prototype.handleNotification=function(e,t){this.handleBufferNotification(e,(function(e,r){t(f(e),r)}))},M.prototype.findRequestHandler=function(e){return this.reqHandlers[e]||this.reqFallbackHandler},M.prototype.findNotificationHandler=function(e){return this.noteHandlers[e]||this.noteFallbackHandler},void 0!==e.gotalkResponderAt){var _=e.gotalkResponderAt;_&&_.ws&&(c.defaultResponderAddress=("https:"==document.location.protocol?"wss://":"ws://")+document.location.host+_.ws),delete e.gotalkResponderAt}p.prototype.open=function(e,t){if(t||"function"!=typeof e||(t=e,e=null),!e){if(!c.defaultResponderAddress)throw new Error("address not specified (responder has not announced any default address)");e=c.defaultResponderAddress}return function(e,t,r){var n;try{(n=new WebSocket(t)).binaryType="arraybuffer",n.onclose=function(e){var t=new Error("connection failed");r&&r(t)},n.onopen=function(t){n.onerror=void 0,e.adoptWebSocket(n),e.handshake(),r&&r(null,e),e.emit("open"),e.startReading()},n.onmessage=function(e){n._bufferedMessages||(n._bufferedMessages=[]),n._bufferedMessages.push(e.data)}}catch(t){r&&r(t),e.emit("close",t)}}(this,e,t),this},c.open=function(e,t){return p(c.defaultHandlers).open(e,t)},p.prototype.openKeepAlive=function(e){var t=this;return t.keepalive&&t.keepalive.disable(),t.keepalive=d(t,e),t.keepalive.enable(),t},c.connection=function(e){return p(c.defaultHandlers).openKeepAlive(e)},c.defaultHandlers=M(),c.handleBufferRequest=function(e,t){return c.defaultHandlers.handleBufferRequest(e,t)},c.handle=function(e,t){return c.defaultHandlers.handleRequest(e,t)},c.handleBufferNotification=function(e,t){return c.defaultHandlers.handleBufferNotification(e,t)},c.handleNotification=function(e,t){return c.defaultHandlers.handleNotification(e,t)}}(t={exports:{}}),e.gotalk=t.exports}(this);